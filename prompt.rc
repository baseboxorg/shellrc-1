setopt prompt_subst
PS1_END="
%{$red%}%(?..!%?! )%{$reset%}%# "


autoload -Uz vcs_info
use_vcs_info=
if vcs_info >/dev/null 2>&1; then
  use_vcs_info=y
fi

if [ "x$use_vcs_info" = "xy" ]; then
  # zsh:
  # %F{2} red
  # %F{2} green
  # %F{3} yellow
  # %F{4} darkblue
  # %F{5} magenta

# zstyle ':vcs_info:*' enable svn git
  zstyle ':vcs_info:*' enable     git
  zstyle ':vcs_info:*' actionformats \
    '%F{5}(%f%s%F{5})%F{3}-%F{5}[%F{2}%b%F{3}|%F{1}%a%F{5}]%f '
  zstyle ':vcs_info:*' formats       \
    '(%s) %b'
  zstyle ':vcs_info:(sv[nk]|bzr):*' branchformat '%b%F{1}:%F{3}%r'
  precmd_hook () {
    if [ $PWD '=~' /$NFS_MOUNTED/ ]; then
      vcs_info_msg_0_=' (nfs mounted)'
    else
      vcs_info
    fi
  }
  PS1='%F{2}%~%F{3}${vcs_info_msg_0_} %(1j.(%j).)%f$PS1_END'
  RPROMPT="%F{2}%*%f"
else
  green="[32m"
  yellow="[33m"
  reset="[0m"
  blue="[00;38;5;33m"

  PS1_HOST='%m:'
  RPROMPT_HOST='@%m'
  if [ `hostname` = a ]; then
    PS1_HOST=
    RPROMPT_HOST=
  fi

  git_prompt=$HOME/src/git/contrib/completion/git-prompt.sh
  if [ -f $git_prompt ]; then
    source $git_prompt
    GIT_PS1_SHOWDIRTYSTATE=true

    precmd_hook() {
      GIT_STATUS=`__git_ps1 ' (%s)'`
    }
    PS1="%{$blue%}\$PS1_HOST%~%{$yellow%}\$GIT_STATUS %(1j.(%j).)%{$reset%}\$PS1_END"
  else
    PS1="%{$blue%}\$PS1_HOST%~ \$PS1_END"
  fi

  RPROMPT="%{$green%}%*\$RPROMPT_HOST%{$reset%}"
fi

# When a line is killed, put it in the history anyway in case we want to
# return to it
TRAPINT() {
       # Store the current buffer in the history.
       zle &&
       [[ $HISTNO -eq $HISTCMD ]] && # only if we're not back in the history
       print -s -r -- $BUFFER

       # Return the default exit code so zsh aborts the current command.
       return $1
}

chpwd() {
  case "$TERM_NAME" in
    "");;
    rtfm) ;;
    #*) screen -X title ${PWD##*/} ;;
    *) screen -X title ${(D)PWD#$HOME/} ;;
  esac
}

precmd() {
  precmd_hook
}

preexec() {
  short_command=$2
  case "$TERM_NAME" in
    "");;
    rtfm) screen -X title ${short_command#man } ;;
  esac
}
